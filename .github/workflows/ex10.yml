name: Ex10 - Build et Déploiement Docker

on:
  push:
    branches:
      - ex10

# -----------------------------------------------------
# 定义任务（Jobs）
# Q1️⃣ : 配置一个工作流，用于构建 Docker 镜像  
# Q2️⃣ : 使用 secrets 登录 Docker Hub 并推送镜像  
# -----------------------------------------------------
jobs:
  build-and-push:   # 唯一的任务名：构建并推送镜像
    runs-on: ubuntu-latest   # 使用 GitHub 提供的 Ubuntu 环境

    steps:
      # 步骤 1️⃣ ：拉取代码仓库 -> GitHub 官方 Action，用于下载当前仓库的全部代码
      - name: Récupérer le dépôt
        uses: actions/checkout@v3

      # =====================================================
      # 步骤 2️⃣ ：（Q2）连接 Docker Hub（登录认证）
      # -----------------------------------------------------
      # 使用 GitHub Secrets 登录 Docker Hub：
      # - secrets.DOCKERHUB_USERNAME : 你的 Docker Hub 用户名
      # - secrets.DOCKERHUB_TOKEN    : 你的 Docker Hub Token（推荐）或密码
      #
      # 相当于命令行执行：
      #   docker login -u 用户名 -p 密码
      # =====================================================
      - name: Se connecter à Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # =====================================================
      # 步骤 3️⃣ ：（Q1 + Q2）构建并推送 Docker 镜像
      # -----------------------------------------------------
      # 使用官方的 docker/build-push-action：
      # - 构建镜像（docker build）
      # - 推送镜像到 Docker Hub（docker push）
      #
      # push: true 表示构建完成后自动推送
      #
      # 镜像名格式：
      #   <用户名>/ex10-github-actions:latest
      #
      # 最终在 Docker Hub 上能看到：
      #   仓库名：ex10-github-actions
      #   tag：latest
      # =====================================================
      - name: Construire et pousser l'image Docker
        uses: docker/build-push-action@v5
        with:
          context: .             # 构建上下文（当前目录）
          file: ./Dockerfile     # 指定 Dockerfile 文件
          push: true             # 构建完成后自动推送
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/ex10-github-actions:latest

      # 步骤 4️⃣ ：（可选）显示完成消息 - 用于在日志中确认推送成功
      - name: Afficher un message de succès
        run: echo "✅ Image Docker construite et poussée avec succès vers Docker Hub !"
